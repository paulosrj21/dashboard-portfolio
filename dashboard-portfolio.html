<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Gestão de Portfólio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .farol-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Dashboard de Gestão de Portfólio</h1>
            <p class="text-gray-600 mt-1">Visão integrada das iniciativas e métricas de fluxo.</p>
        </header>

        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button onclick="changeTab('metrics')" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="metrics">
                    Métricas de Fluxo
                </button>
                <button onclick="changeTab('summary')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="summary">
                    Sumário de Projetos
                </button>
                <button onclick="changeTab('matrix')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="matrix">
                    Matriz de Priorização
                </button>
            </nav>
        </div>

        <main id="dashboard-main-content">
            <div class="text-center py-10">
                <p class="text-gray-500">Carregando dados da planilha...</p>
            </div>
        </main>
    </div>

    <script>
        // --- FUNÇÃO PARA BUSCAR E PROCESSAR OS DADOS ---
        async function carregarDadosDaPlanilha() {
            const urlPlanilha = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBgoOo6EBhtoY_n3pkqoUHLNDJtrFx0j_9H32mqIdYWIYCY13BW5kjl6GlNtgyMU4jU7vSUKrvYCw/pub?gid=0&single=true&output=csv'; 
            // Usamos um proxy para evitar problemas de CORS (Cross-Origin Resource Sharing)
            const proxiedUrl = 'https://corsproxy.io/?' + urlPlanilha;

            try {
                const resposta = await fetch(proxiedUrl);
                if (!resposta.ok) throw new Error(`Erro na rede: ${resposta.statusText}`);
                const textoCsv = await resposta.text();
                
                const linhas = textoCsv.trim().split(/\r?\n/);
                const cabecalho = linhas[0].split(',').map(h => h.trim());
                const csvRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

                const dadosJson = linhas.slice(1).map(linha => {
                    const valores = linha.split(csvRegex);
                    const obj = {};
                    cabecalho.forEach((chave, i) => {
                        let valor = valores[i] ? valores[i].trim() : '';
                        if (valor.startsWith('"') && valor.endsWith('"')) {
                            valor = valor.substring(1, valor.length - 1);
                        }
                        const colunasNumericas = ['id', 'progresso', 'prioridade', 'impacto'];
                        if (colunasNumericas.includes(chave) && valor !== '' && !isNaN(Number(valor))) {
                            obj[chave] = Number(valor);
                        } else {
                            obj[chave] = valor;
                        }
                    });
                    return obj;
                });
                return dadosJson;
            } catch (error) {
                console.error('Erro ao buscar dados da planilha:', error);
                return null; // Retorna null em caso de erro
            }
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO (AGORA RECEBEM DADOS) ---

        function renderMainLayout(projectData) {
            const main = document.getElementById('dashboard-main-content');
            main.innerHTML = `
                <!-- Aba 1: Métricas de Fluxo -->
                <div id="metrics-content" class="tab-content active">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100 col-span-1 sm:col-span-2 lg:col-span-4">
                            <h3 class="text-sm font-medium text-gray-500">Extrato por Complexidade</h3>
                            <canvas id="complexityChart" class="mt-4"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Aba 2: Sumário de Projetos -->
                <div id="summary-content" class="tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Iniciativa</th><th scope="col" class="px-6 py-3">Responsável</th><th scope="col" class="px-6 py-3">Fluxo</th><th scope="col" class="px-6 py-3">Progresso</th><th scope="col" class="px-6 py-3">Farol</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3">GP</th>
                                </tr>
                            </thead>
                            <tbody id="projects-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Aba 3: Matriz de Priorização -->
                <div id="matrix-content" class="tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="filter-gp" class="block text-sm font-medium text-gray-700">Filtrar por GP</label>
                                <select id="filter-gp" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"><option>Todos</option></select>
                            </div>
                            <div>
                                <label for="filter-area" class="block text-sm font-medium text-gray-700">Filtrar por Área</label>
                                <select id="filter-area" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"><option>Todos</option></select>
                            </div>
                            <div>
                                <label for="filter-status" class="block text-sm font-medium text-gray-700">Filtrar por Status</label>
                                <select id="filter-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"><option>Todos</option><option>Em dia</option><option>Oportunidade</option><option>Atenção</option><option>Impedido</option></select>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-1">
                        <div class="p-2 text-center font-bold"></div><div class="p-2 text-center font-bold text-sm bg-gray-100 rounded-t-lg">Baixa (1)</div><div class="p-2 text-center font-bold text-sm bg-gray-100 rounded-t-lg">Média (2)</div><div class="p-2 text-center font-bold text-sm bg-gray-100 rounded-t-lg">Alta (3)</div>
                        <div class="p-2 text-center font-bold text-sm bg-gray-100 rounded-l-lg self-center">Forte (3)</div><div id="cell-3-1" class="bg-yellow-100 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-yellow-200"></div><div id="cell-3-2" class="bg-green-100 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-green-200"></div><div id="cell-3-3" class="bg-red-100 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-red-200"></div>
                        <div class="p-2 text-center font-bold text-sm bg-gray-100 rounded-l-lg self-center">Médio (2)</div><div id="cell-2-1" class="bg-blue-100 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-blue-200"></div><div id="cell-2-2" class="bg-yellow-100 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-yellow-200"></div><div id="cell-2-3" class="bg-green-100 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-green-200"></div>
                        <div class="p-2 text-center font-bold text-sm bg-gray-100 rounded-l-lg self-center">Fraco (1)</div><div id="cell-1-1" class="bg-gray-200 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-gray-300"></div><div id="cell-1-2" class="bg-blue-100 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-blue-200"></div><div id="cell-1-3" class="bg-yellow-100 rounded-lg p-3 min-h-[150px] border-2 border-dashed border-yellow-200"></div>
                    </div>
                </div>
            `;
            // Após injetar o HTML, podemos chamar as funções que preenchem esses elementos
            renderComplexityChart(projectData);
            renderSummaryTable(projectData);
            setupFiltersAndMatrix(projectData);
        }
        
        function renderComplexityChart(data) {
            const ctx = document.getElementById('complexityChart').getContext('2d');
            const projectCounts = data.reduce((acc, p) => {
                const score = p.prioridade + p.impacto;
                if (score <= 3) acc['Baixa Relevância'] = (acc['Baixa Relevância'] || 0) + 1;
                else if (score === 4) acc['Oportunidade Tática'] = (acc['Oportunidade Tática'] || 0) + 1;
                else if (score >= 5) acc['Alta Prioridade'] = (acc['Alta Prioridade'] || 0) + 1;
                return acc;
            }, {});
            new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(projectCounts), datasets: [{ label: 'Nº de Iniciativas', data: Object.values(projectCounts), backgroundColor: ['rgba(156, 163, 175, 0.7)', 'rgba(251, 191, 36, 0.7)', 'rgba(59, 130, 246, 0.7)'], borderColor: ['rgba(156, 163, 175, 1)', 'rgba(251, 191, 36, 1)', 'rgba(59, 130, 246, 1)'], borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
        }

        function renderSummaryTable(data) {
            const tableBody = document.getElementById('projects-table-body');
            if(!tableBody) return;
            tableBody.innerHTML = '';
            const farolColors = { 'Em dia': 'bg-green-500', 'Oportunidade': 'bg-blue-500', 'Atenção': 'bg-yellow-400', 'Impedido': 'bg-red-500', 'Descartado': 'bg-gray-400' };
            data.forEach(p => {
                const progressPercentage = (p.progresso * 100).toFixed(0);
                tableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${p.iniciativa}</td><td class="px-6 py-4">${p.responsavel}</td><td class="px-6 py-4">${p.fluxo}</td><td class="px-6 py-4"><div class="flex items-center"><div class="w-full bg-gray-200 rounded-full h-2.5 mr-2"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div></div><span>${progressPercentage}%</span></div></td><td class="px-6 py-4"><div class="flex items-center"><span class="farol-dot ${farolColors[p.farol] || 'bg-gray-300'} mr-2"></span>${p.farol}</div></td><td class="px-6 py-4 text-xs">${p.status}</td><td class="px-6 py-4">${p.gp}</td></tr>`;
            });
        }

        function renderMatrix(data) {
            document.querySelectorAll('[id^="cell-"]').forEach(cell => cell.innerHTML = '');
            data.forEach(p => {
                if (p.fluxo === '99. Descarte' || !p.impacto || !p.prioridade) return;
                const cell = document.getElementById(`cell-${p.impacto}-${p.prioridade}`);
                if (cell) {
                    const score = p.impacto + p.prioridade;
                    let bgColor = 'bg-gray-200';
                    if (score <= 3) bgColor = 'bg-blue-200'; else if (score === 4) bgColor = 'bg-yellow-200'; else if (score === 5) bgColor = 'bg-green-200'; else if (score >= 6) bgColor = 'bg-red-200';
                    cell.innerHTML += `<div class="p-2 ${bgColor} rounded-md shadow-sm mb-2 text-xs cursor-pointer" title="${p.status}"><p class="font-bold truncate">${p.iniciativa}</p><p class="text-gray-600">${p.gp} / ${p.responsavel}</p></div>`;
                }
            });
        }
        
        function setupFiltersAndMatrix(projectData) {
            const gpFilter = document.getElementById('filter-gp');
            const areaFilter = document.getElementById('filter-area');
            const statusFilter = document.getElementById('filter-status');
            
            const gps = [...new Set(projectData.map(p => p.gp))].filter(Boolean);
            const areas = [...new Set(projectData.map(p => p.responsavel))].filter(Boolean);
            gps.sort().forEach(gp => gpFilter.innerHTML += `<option>${gp}</option>`);
            areas.sort().forEach(area => areaFilter.innerHTML += `<option>${area}</option>`);

            function applyFiltersAndRender() {
                const selectedGp = gpFilter.value;
                const selectedArea = areaFilter.value;
                const selectedStatus = statusFilter.value;
                const filteredData = projectData.filter(p => (selectedGp === 'Todos' || p.gp === selectedGp) && (selectedArea === 'Todos' || p.responsavel === selectedArea) && (selectedStatus === 'Todos' || p.farol === selectedStatus));
                renderMatrix(filteredData);
            }

            gpFilter.addEventListener('change', applyFiltersAndRender);
            areaFilter.addEventListener('change', applyFiltersAndRender);
            statusFilter.addEventListener('change', applyFiltersAndRender);
            
            applyFiltersAndRender(); // Renderização inicial
        }

        // --- LÓGICA DAS ABAS ---
        function changeTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`[data-tab='${tabName}']`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', async () => {
            const projectData = await carregarDadosDaPlanilha();
            if (projectData && projectData.length > 0) {
                renderMainLayout(projectData);
            } else {
                document.getElementById('dashboard-main-content').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                        <strong class="font-bold">Erro ao carregar dados!</strong>
                        <span class="block sm:inline">Não foi possível buscar as informações da planilha. Verifique se o link está correto e se a planilha está publicada como CSV.</span>
                    </div>`;
            }
        });
    </script>
</body>
</html>